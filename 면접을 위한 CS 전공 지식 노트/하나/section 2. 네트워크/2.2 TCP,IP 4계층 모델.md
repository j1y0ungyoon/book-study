# 2.2 TCP/IP 4계층 모델

TCP/IP(transmission control protocol/internet protocol)는 데이터가 의도된 목적지에 닿을 수 있도록 보장해주는 통신 프로토콜\* 임.
간단하게 말하자면 TCP는 전송제어 프로토콜, IP는 인터넷 프로토콜임
많은 프로토콜이 있지만 그 중에 많이 사용되는 규약이 TCP/IP이고 이를 TCP/IP 4계층으로 설명함
이 계층은 네트워크에서 사용되는 통신 프로토콜의 집합으로 총 4개의 계층으로 나뉨

\*프로토콜
컴퓨터 간 데이터를 통신하기 위해 정해놓은 규약

## 2.2.1 계층 구조

<img src="https://raonctf.com/static/essential/images/network/network_layer_02.jpg" width="50%" height="50%">

TCP/IP 계층은 네 개의 계층을 가지고 있으며 OSI 계층과 많이 비교함. 각 계층은 특정 계층이 변경되었을 때 다른 계층이 영향을 받지 않도록 설계됨.

책에서는 TCP/IP 4계층을 설명하고 있기에 이를 중점으로 적겠음

### 어플리케이션 계층

웹서비스, 이메일 등 실질적으로 유저에게 서비스를 제공하는 층

- 대표 스택
  - FTP : 장치와 장치 간의 파일을 전송하는 데 사용되는 표준 통신 프로토콜
  - HTTP : 보안되지 않은 네트워크에서 네트워크 서비스를 안전하게 운영하기 위한 프로토콜
  - SSH : world wide web을 위한 데이터 통신의 기초이자 웹 사이트를 이용하는 데 쓰는 프로토콜
  - SMTP : 전자메일 전송을 위한 인터넷 표준 통신 프로토콜
  - DNS : 도메인 이름과 ip주소를 매핑해주는 서버

### 전송 계층

- 송신자와 수신자를 연결하는 통신 서비스를 제공함
- 연결 지향 데이터 스트림 지원, 신뢰성, 흐름 제어를 제공할 수 있으며 애플리케이션과 인터넷 계층 사이의 데이터가 전달될 때 중계 역할을 함

- 대표 스택
  - TCP : 패킷 사이의 순서를 보장하고 연결지향 프로토콜을 사용해 연결을 해 신뢰성을 구축 -> 수신여부 확인, 가상회선 패킷 교환 방식\* 사용
  - UDP : 순서 보장x, 수신 여부를 확인하지 않으며 단순히 데이터만 주는 데이터그램 패킷 교환 방식\* 사용
    - 예시: 실시간 스트리밍, 온라인 게임 등

\*가상회선 패킷 교환 방식

각 패킷에는 가상회선 식별자가 포함되며 모든 패킷을 전송하면 가상회선이 해제되고 패킷들은 전송된 '순서대로' 도착하는 방식

\*데이터그램 패킷 교환 방식

패킷이 독립적으로 이동하며 최적의 경로를 선택해 가는데, 하나의 메시지에서 분할된 여러 패킷은 서로 다른 경로로 전송될 수 있으며 도착한 순서가 다를 수 있는 방식을 뜻함

#### TCP 연결 성립 과정

TCP는 신뢰성을 확보할 때 3-way-handshake라는 작업을 진행함

1. SYN(Synchronize: 연결 요청 플래그) 단계
   클라이언트는 서버에 TCP 연결을 요청하기 위해 클라이언트의 ISN(새로운 TCP연결의 첫 번째 패킷에 할당된 임의의 시퀀스 번호를 말함. 장치마다 다를 수 있음, 초기 네트워크 연결을 할 때 할당된 32비트의 고유 시퀀스 번호)을 담아 보냄.

2. SYN + ACK(Acknowledgment: 응답 플래그) 단계
   서버는 클라이언트의 SYN을 수신하고, 서버의 ISN을 보내며 승인번호로 클라이언트 SYN + 1을 보냄(서버가 클라이언트의 syn를 받았음을 의미함)

3. ACK 단계
   클라이언트는 서버의 ISN + 1한 값인 승인 번호를 담아 ACK를 서버로 보냄(클라이언트는 서버의 SYN + ACK를 받았음을 알려주기 위해 ACK를 서버로 보냄) -> 3-way-handshake 완료 -> 연결 성립

이런 3-way-handshake 과정 이후 신뢰성 구축 -> 데이터 전송 시작.
TCP는 이 과정을 거치기 때문에 신뢰성이 있는 계층이라고 하며, UDP는 이 과정을 거치지 않기 때문에 신뢰성이 없는 계층이라고 함

#### TCP 연결 해제 과정

TCP가 연결을 해제할 때는 4-way-handshake 과정이 필요함

1. 클라이언트가 연결 종료 요청을 보냄
   클라이언트가 연결을 종료하려고 할 때, FIN(종료 요청) 플래그를 설정한 세그먼트를 서버에게 보냄. 그리고 클라이언트는 FIN_WAIT_1 상태로 진입하고, 서버의 응답을 기다림

2. 서버가 클라이언트의 연결 종료 요청에 응답함
   서버는 FIN 패킷을 받고 해당 연결에 대한 데이터를 모두 보냈다는 것을 ACK(응답 확인) 플래그를 설정한 세그먼트를 클라이언트에게 보냄. 이로써 서버는 클라이언트의 연결 종료 요청을 확인하고, CLOSE_WAIT 상태로 진입함. 클라이언트는 ACK를 받으면 FIN_WAIT_2 상태로 진입함

3. 서버가 연결 종료를 위한 작업을 수행함
   서버는 클라이언트의 ACK를 받은 후에 일정 시간(2 MSL, Maximum Segment Lifetime) 동안 TIME_WAIT 상태로 대기함. 이동통신망이나 다중 경로로 도착하는 경우에도 패킷이 중복되거나 지연되어 올 수 있으므로 TIME_WAIT 상태에서 대기함으로써 이전 연결의 모든 패킷이 완전히 소멸되도록 함

4. 클라이언트가 서버의 연결 종료 요청에 응답함
   클라이언트는 TIME_WAIT 상태에서 대기한 후에, 서버로부터 온 FIN 세그먼트에 대한 ACK를 보냄. 이로써 클라이언트는 CLOSED 상태로 진입하고, 연결이 완전히 종료됨. 서버는 ACK를 받으면 CLOSED 상태가 됨

근데 연결을 바로 닫으면 되지 왜 일정 시간 뒤에 닫을까?

1. 지연 패킷이 발생할 경우를 대비하기 위해서
   패킷이 뒤늦게 도달하고 이를 처리하지 못한다면 데이터 무결성 문제\*가 발생함
   ex: 전체 데이터가 100개인데 50개만 들어오는 경우

2. 두 장치가 연결이 닫혔는지 확인하기 위해서
   만약 LASK_ACK 상태에서 닫히게 되면 새로운 연결을 하려고 할 때 장치는 계속 LAST_ACK로 되어있기 때문에 접속 오류가 나타나게 됨

때문에 TIME_WAIT\*라는 기다리는 시간이 필요함

\*TIME_WAIT

- 소켓이 바로 소멸되지 않고 일정 시간 유지되는 상태를 말함
- 지연 패킷 등의 문제점을 해결하는 데 사용됨
- os 마다 시간은 다름

\*데이터 무결성
데이터의 정확성과 일관성을 유지하고 보증하는 것

### 인터넷 계층

- 대표적인 스택: IP, ARP, ICMP
  장치로부터 받은 네트워크 패킷을 IP 주소로 지정된 목적지로 전송하기 위해 사용되는 계층
- 패킷을 수신해야 할 상대의 주소를 지정해 데이터를 전달함
- 상대방이 제대로 받았는지에 대해 보장하지 않는 비연결적인 특징을 가짐

### 링크 계층(네트워크 접근 계층)

- 전선, 광섬유, 무선 등으로 실질적으로 데이터를 전달하며, 장치 간의 신호를 주고 받는 규칙을 정하는 계층
- 물리 계층과 데이터 링크 계층으로 나누기도 함
- 물리 계층: 무선 LAN과 유선 LAN을 통해 0과 1로 이루어진 데이터를 보내는 계층을 말함
- 데이터 링크 계층 : 이더넷 프레임을 통해 에러 확인, 흐름 제어, 접근 제어를 담당하는 계층을 말함

#### 유선LAN

- IEE802.3이라는 프로토콜을 따름
- 전이중화 통신\*을 씀

\*전이중화 통신(full duplex)

- 양쪽 장치가 동시에 송수신할 수 있는 방식을 말함(같은 시간에 데이터를 주고 받을 수 있음)
- 송신로와 수신로로 나누어서 데이터를 주고 받음
- 현대의 고속 이더넷은 이 방식을 기반으로 통신함

\*CSMA/CD(carrier sense multiple access with collision detection)

- 전이중화 통신 사용 전에는 이 방식을 사용함(반이중화 통신 중 하나임)
- 데이터를 보낸 이후 충돌이 발생한다면 일정 시간 이후 재전송하는 방식을 말함
- 전이중화 통신과 달리 수신로와 송신로를 각각 둔 것이 아니라 한 경로를 기반으로 데이터를 보내기 때문에 데이터를 보낼 때 충돌에 대해 대비해야했기 때문

#### 무선랜

- IEEE802.11 프로토콜 사용
- 수신과 송신에 같은 채널을 사용하기 때문에 반이중화 통신\* 사용

\*반이중화 통신

- 양쪽 장치는 서로 통신할 수 있지만 동시에 통신할 수 X
- 한 번에 한 방향으로만 통신할 수 있는 방식을 말함
- 둘 이상의 장치가 동시에 전송하면 충돌이 발생 -> 메세지 손상 혹은 왜곡 -> 충돌 방지 시스템 필요

\*CSMA/CA

- 반이중화 통신 중 하나
- 장치로 데이터를 보내기 전에 캐리어 감지 등으로 사전에 가능한 한 충돌을 방지하는 방식을 사용해 아래와 같이 이루어짐

1. 데이터를 송신하기 전에 무선 매체를 확인
2. 캐리어 감지 : 회선이 비어있는지 확인
3. IFS(inter framespace) : 랜덤 값을 기반으로 정해진 시간만큼 기다리며 만약 무선 매체가 사용 중이면 점차 그 간격을 늘려가며 기다림
4. 이후에 데이터 송신

#### 계층 간 데이터 송수신 과정

예시 : HTTP를 통해 웹 서버에 있는 데이터 요청함

<img src="https://velog.velcdn.com/images/ho-taek/post/7bf3bb89-24fe-4330-b877-dbc8d58797d0/image.png" width="50%" height="50%">

애플리케이션 계층 -> 전송계층으로 유저가 보내는 요청 값들이 캡슐화 과정* 을 거쳐서 전달 -> 링크 계층을 통해 해당 서버와 통신을 하고, 해당 서버의 링크 계층으로부터 애플리케이션까지 비캡슐화 과정* 을 거쳐 데이터가 전송됨

\*캡술화 과정

- 상위 게층의 헤더와 데이터를 하위 계층의 데이터 부분에 포함시키고 해당 계층의 헤더를 삽입하는 과정

<img src="https://velog.velcdn.com/images/ho-taek/post/d4e52978-cd29-4404-888c-e5fdbbddf4d9/image.png" width="50%" height="50%">

\*비캡술화 과정

- 하위 계층에서 상위 계층으로 가며 각 계층의 헤더 부분을 제거하는 과정

<img src="https://velog.velcdn.com/images/ho-taek/post/9a077e55-8397-4446-85c4-8345bcccc554/image.png" width="50%" height="50%">

### 2.2.2 PDU(protocol data unit)

- 네트워크의 어떠한 계층에서 계층으로 데이터가 전달될 때 한 덩어리의 단위를 말함
- 제어 관련 정보들이 포함된 헤더, 데이터를 의미하는 페이로드로 구성됨(계층마다 명칭이 다름)

  - 애플리케이션 계층 : 메시지
  - 전송 계층 : 세그먼트(TCP), 데이터그램(UDP)
  - 인터넷 계층 : 패킷
  - 링크 계층 : 프레임(데이터 링크 계층), 비트(물리 계층)

- PDU 중 아래 계층인 비트로 송수신하는 것이 가장 빠르고 효율성이 높음
- 하지만 애플리케이션 계층에서는 문자열을 기반으로 송수신을 함 -> 왜냐면 다른 값들을 넣는 확장이 쉽기 때문
